<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuraPOS | South Africa Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400 ;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js "></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js "></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js "></script>
    <style>
        :root {
            --primary-grad: linear-gradient(135deg, #FFD700 0%, #FFB800 100%);
            --white: #ffffff;
            --bg-light: #F7F9FC;
            --dark-text: #1A1C1E;
            --muted-text: #6C757D;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.04);
            --transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }

        html { font-size: 16px; }

        body { 
            background-color: var(--bg-light); 
            color: var(--dark-text); 
            display: flex; 
            min-height: 100vh; 
            overflow-x: hidden; 
        }

        /* Sidebar Navigation */
        sidebar {
            width: 280px;
            min-width: 280px;
            background: var(--white);
            border-right: 1px solid rgba(0,0,0,0.05);
            padding: 40px 30px;
            position: fixed;
            height: 100vh;
            display: flex;
            flex-direction: column;
            z-index: 100;
            animation: slideInLeft 0.6s cubic-bezier(0.165, 0.84, 0.44, 1);
            overflow-y: auto;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 50px;
            animation: fadeInDown 0.8s ease;
        }

        .logo-sq {
            width: 45px;
            height: 45px;
            min-width: 45px;
            background: var(--primary-grad);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 22px;
            color: #000;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
            transition: transform 0.3s ease;
        }

        .logo-sq:hover { transform: rotate(10deg) scale(1.1); }

        .logo-text { font-size: 24px; font-weight: 800; letter-spacing: -1px; white-space: nowrap; }

        /* Sidebar Nav Items & Animations */
        .nav-item {
            padding: 14px 20px;
            margin-bottom: 10px;
            border-radius: 16px;
            font-weight: 600;
            color: var(--muted-text);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            z-index: 1;
            display: flex;
            align-items: center;
            transform-origin: left center;
            white-space: nowrap;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.03);
            z-index: -1;
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            border-radius: 16px;
        }

        .nav-item:hover {
            color: var(--dark-text);
            transform: translateX(6px) scale(1.02);
        }

        .nav-item:hover::before {
            transform: scaleX(1);
        }

        .nav-item.active {
            color: #000;
            background: var(--primary-grad);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.25);
            transform: scale(1.02);
            font-weight: 800;
            animation: pulse 2s infinite;
        }

        .nav-item.active::before {
            display: none;
        }

        .nav-item:active {
            transform: scale(0.98);
        }

        /* Main Dashboard & Views */
        main { 
            margin-left: 280px; 
            padding: clamp(20px, 4vw, 50px); 
            width: calc(100% - 280px); 
            min-width: 0;
            animation: fadeIn 1s ease; 
        }

        .view {
            display: none;
            animation: fadeIn 0.6s ease forwards;
        }

        .view.active {
            display: block;
        }

        .header-flex { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 40px; 
            flex-wrap: wrap;
            gap: 20px;
            animation: slideInDown 0.5s ease; 
        }
        
        .greeting { flex: 1; min-width: 250px; }
        .greeting h1 { 
            font-size: clamp(24px, 3vw, 32px); 
            font-weight: 800; 
        }
        
        .header-flex > div:last-child { text-align: right; min-width: 150px; }
        
        .status-pill { 
            background: #E3FCEF; 
            color: #00B894; 
            padding: 6px 16px; 
            border-radius: 50px; 
            font-size: 13px; 
            font-weight: 600; 
            animation: pulse 2s infinite;
            white-space: nowrap;
        }

        /* Modern Grid */
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: minmax(300px, 350px) 1fr; 
            gap: clamp(20px, 3vw, 30px); 
        }

        .card {
            background: var(--white);
            padding: clamp(20px, 3vw, 30px);
            border-radius: 24px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: var(--transition);
            animation: slideInUp 0.5s ease;
            width: 100%;
            min-width: 0;
        }

        .card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.08); }

        h3 { 
            font-size: clamp(16px, 2vw, 18px); 
            margin-bottom: 25px; 
            font-weight: 700; 
            opacity: 0.9; 
        }

        /* Form Inputs */
        .input-group { margin-bottom: 20px; }
        label { 
            display: block; 
            font-size: clamp(12px, 1.5vw, 13px); 
            font-weight: 600; 
            color: var(--muted-text); 
            margin-bottom: 8px; 
        }
        input, select {
            width: 100%;
            padding: clamp(12px, 2vw, 14px) clamp(15px, 2vw, 20px);
            border-radius: 16px;
            border: 1.5px solid #F1F3F5;
            background: #F8F9FA;
            font-weight: 600;
            transition: var(--transition);
            color: var(--dark-text);
            font-size: clamp(14px, 1.5vw, 15px);
            min-height: 48px;
        }
        input:focus, select:focus { 
            outline: none; 
            border-color: #FFD700; 
            background: #fff; 
            box-shadow: 0 0 0 4px rgba(255, 215, 0, 0.1); 
            transform: scale(1.01); 
        }

        /* Shimmer Pill Button */
        .btn-pill {
            position: relative;
            overflow: hidden;
            background: var(--primary-grad);
            border: none;
            padding: clamp(14px, 2vw, 16px) clamp(20px, 3vw, 30px);
            border-radius: 50px;
            color: #000;
            font-weight: 800;
            font-size: clamp(14px, 1.5vw, 15px);
            cursor: pointer;
            width: 100%;
            transition: var(--transition);
            box-shadow: 0 10px 20px rgba(255, 215, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 48px;
        }

        .btn-pill:hover { transform: scale(1.02); box-shadow: 0 15px 25px rgba(255, 215, 0, 0.3); }

        .btn-pill::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(60deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-150%) rotate(45deg); }
            100% { transform: translateX(150%) rotate(45deg); }
        }

        /* Inventory Table */
        .table-container { 
            overflow-x: auto; 
            width: 100%;
        }
        .table-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            flex-wrap: wrap;
            gap: 15px;
        }
        .search-bar { 
            width: 100%;
            max-width: 250px; 
            padding: 10px 15px; 
            border-radius: 12px; 
        }

        table { 
            width: 100%; 
            min-width: 600px;
            border-collapse: separate; 
            border-spacing: 0 12px; 
        }
        th { 
            text-align: left; 
            padding: 0 clamp(10px, 2vw, 20px); 
            color: var(--muted-text); 
            font-size: clamp(11px, 1.2vw, 13px); 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            white-space: nowrap;
        }
        
        tr.category-row td { 
            padding: 10px clamp(10px, 2vw, 20px); 
            font-weight: 800; 
            color: var(--muted-text); 
            background: #fdfdfd; 
            font-size: clamp(11px, 1.2vw, 12px); 
            text-transform: uppercase; 
            animation: fadeIn 0.3s ease; 
        }
        
        tr.item-row { 
            background: var(--white); 
            transition: var(--transition); 
            cursor: default; 
            animation: slideInRight 0.4s ease; 
        }
        tr.item-row td { 
            padding: clamp(15px, 2vw, 20px) clamp(10px, 2vw, 20px); 
            border-top: 1px solid #F1F3F5; 
            border-bottom: 1px solid #F1F3F5; 
            font-size: clamp(13px, 1.5vw, 14px);
        }
        tr.item-row td:first-child { 
            border-left: 1px solid #F1F3F5; 
            border-top-left-radius: 16px; 
            border-bottom-left-radius: 16px; 
        }
        tr.item-row td:last-child { 
            border-right: 1px solid #F1F3F5; 
            border-top-right-radius: 16px; 
            border-bottom-right-radius: 16px; 
        }

        .price-tag { 
            font-weight: 800; 
            color: var(--dark-text); 
            font-size: clamp(14px, 1.8vw, 16px); 
            display: flex; 
            flex-direction: column; 
        }
        .discount-text { 
            font-size: clamp(10px, 1.2vw, 11px); 
            text-decoration: line-through; 
            color: var(--muted-text); 
        }
        
        .stock-badge { 
            padding: 6px 12px; 
            border-radius: 10px; 
            font-size: clamp(11px, 1.2vw, 12px); 
            font-weight: 700; 
            background: #e9ecef; 
            color: #495057;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        /* Stock Alert Classes */
        .stock-safe { background: #E3FCEF; color: #00B894; }
        .stock-low { background: #FFF3CD; color: #856404; animation: pulse 2s infinite; }
        .stock-out { background: #FFE5E5; color: #D63031; animation: shake 0.5s ease-in-out; }

        .btn-edit, .btn-delete {
            padding: clamp(6px, 1vw, 8px) clamp(12px, 2vw, 18px);
            border-radius: 50px;
            font-size: clamp(11px, 1.2vw, 12px);
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            margin-right: 6px;
            border: none;
            white-space: nowrap;
        }
        .btn-edit { background: #0984E3; color: white; }
        .btn-edit:hover { background: #0770c2; transform: scale(1.05); }
        .btn-delete { background: #D63031; color: white; }
        .btn-delete:hover { background: #b52b2b; transform: scale(1.05); }

        /* Analytics Section */
        .analytics-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: clamp(15px, 2vw, 20px); 
            margin-top: 30px; 
        }
        .chart-container { 
            position: relative; 
            height: clamp(150px, 25vw, 200px); 
            width: 100%; 
            min-height: 150px;
        }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            max-width: 90vw;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            right: 30px;
            bottom: 30px;
            font-size: clamp(13px, 1.5vw, 14px);
            font-weight: 600;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            transform: translateY(100px);
            transition: all 0.3s ease;
        }
        #toast.show {
            visibility: visible;
            transform: translateY(0);
            animation: slideInUp 0.5s ease;
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-50px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* NEW MANAGER FEATURES */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: clamp(15px, 2vw, 20px);
            margin-bottom: 35px;
        }
        .kpi-card {
            background: var(--white);
            padding: clamp(20px, 3vw, 26px) clamp(15px, 2vw, 22px);
            border-radius: 22px;
            box-shadow: var(--card-shadow);
            text-align: center;
            transition: var(--transition);
            animation: slideInUp 0.5s ease;
        }
        .kpi-card:hover { transform: translateY(-4px) scale(1.02); }
        .kpi-value {
            font-size: clamp(24px, 3vw, 29px);
            font-weight: 800;
            line-height: 1;
            margin: 10px 0 6px;
            transition: all 0.3s ease;
        }
        .kpi-card:hover .kpi-value { transform: scale(1.1); }
        .kpi-label {
            font-size: clamp(12px, 1.4vw, 13.5px);
            color: var(--muted-text);
            font-weight: 600;
        }
        .kpi-change {
            font-size: clamp(12px, 1.3vw, 13px);
            font-weight: 700;
        }
        .change-positive { color: #00B894; }
        .change-negative { color: #D63031; }

        .period-toggle {
            display: inline-flex;
            background: var(--white);
            padding: 6px;
            border-radius: 50px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .period-btn {
            padding: clamp(8px, 1.5vw, 10px) clamp(18px, 2.5vw, 26px);
            border: none;
            background: transparent;
            border-radius: 50px;
            font-weight: 700;
            font-size: clamp(12px, 1.4vw, 14px);
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }
        .period-btn.active {
            background: var(--primary-grad);
            color: #000;
            box-shadow: 0 6px 18px rgba(255,215,0,0.25);
            transform: scale(1.05);
        }

        .live-ticker {
            max-height: clamp(200px, 30vw, 260px);
            overflow-y: auto;
            padding: 4px;
        }
        .ticker-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: clamp(10px, 2vw, 13px) clamp(12px, 2vw, 18px);
            background: #f8f9fa;
            margin-bottom: 8px;
            border-radius: 14px;
            font-size: clamp(13px, 1.5vw, 14.5px);
            transition: all 0.3s ease;
            animation: slideInRight 0.3s ease;
            flex-wrap: wrap;
            gap: 10px;
        }
        .ticker-item:hover { 
            transform: translateX(5px); 
            background: #fff; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
        }

        .low-stock-panel {
            background: #FFF5F5;
            border: 2px solid #FFE5E5;
            animation: pulse 3s infinite;
        }
        .alert-item {
            padding: clamp(12px, 2vw, 15px) clamp(12px, 2vw, 18px);
            border-bottom: 1px solid #FFE5E5;
            font-size: clamp(13px, 1.5vw, 14px);
            transition: all 0.3s ease;
        }
        .alert-item:hover { 
            background: rgba(255, 230, 230, 0.5); 
            transform: translateX(5px); 
        }

        .goal-card {
            background: var(--white);
            padding: clamp(20px, 3vw, 26px);
            border-radius: 22px;
            box-shadow: var(--card-shadow);
            text-align: center;
            transition: var(--transition);
        }
        .goal-card:hover { transform: translateY(-3px); }
        .goal-bar {
            height: 10px;
            background: #e9ecef;
            border-radius: 50px;
            overflow: hidden;
            margin: 16px 0;
        }
        .goal-progress {
            height: 100%;
            background: var(--primary-grad);
            width: 68%;
            transition: width 1s ease;
            animation: shimmer 2s infinite;
        }

        /* Sales History Table */
        #salesBody tr {
            background: var(--white);
            animation: fadeIn 0.3s ease;
        }

        /* Edit Modal */
        #editModal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
            padding: 20px;
        }
        .modal-content {
            background: var(--white);
            padding: clamp(25px, 4vw, 40px);
            border-radius: 24px;
            width: 100%;
            max-width: 420px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--card-shadow);
            animation: slideInUp 0.4s ease;
        }

        /* Delete Confirmation Modal */
        #deleteModal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2001;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
            padding: 20px;
        }
        .delete-modal-content {
            background: var(--white);
            padding: clamp(25px, 4vw, 40px);
            border-radius: 24px;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--card-shadow);
            text-align: center;
            animation: slideInUp 0.4s ease;
        }
        .delete-modal-content h3 { color: #D63031; margin-bottom: 15px; }
        .delete-modal-content p { color: var(--muted-text); margin-bottom: 25px; }
        .delete-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .btn-cancel {
            background: #e9ecef;
            color: #333;
            border: none;
            padding: clamp(12px, 2vw, 14px) clamp(20px, 3vw, 30px);
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
            min-width: 120px;
        }
        .btn-cancel:hover { background: #dee2e6; transform: scale(1.02); }
        .btn-confirm-delete {
            background: #D63031;
            color: white;
            border: none;
            padding: clamp(12px, 2vw, 14px) clamp(20px, 3vw, 30px);
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
            min-width: 120px;
        }
        .btn-confirm-delete:hover { background: #b52b2b; transform: scale(1.02); }

        /* Settings Form */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: clamp(15px, 2vw, 25px);
        }

        /* Image preview in edit modal */
        .image-preview {
            width: 100%;
            height: clamp(120px, 20vw, 150px);
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 2px dashed #ddd;
        }

        /* Date Filter Styles - Matching the image */
        .date-filter-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .date-filter-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #1A1C1E;
            color: #ffffff;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .date-filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
            background: #2C2E33;
        }

        .date-filter-btn svg {
            width: 18px;
            height: 18px;
            stroke: #FFD700;
        }

        .date-filter-input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .date-range-display {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--white);
            padding: 10px 16px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-text);
            box-shadow: var(--card-shadow);
        }

        .date-range-display svg {
            width: 16px;
            height: 16px;
            color: var(--muted-text);
        }

        /* Responsive Breakpoints */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding: 20px;
                flex-direction: row;
                flex-wrap: wrap;
                align-items: center;
                gap: 15px;
            }
            
            sidebar > div:first-of-type {
                margin-bottom: 0;
                flex: 1;
            }
            
            sidebar > p {
                display: none;
            }
            
            sidebar > div:nth-of-type(2) {
                display: flex;
                flex-direction: row;
                gap: 10px;
                flex-wrap: wrap;
                width: 100%;
            }
            
            .nav-item {
                margin-bottom: 0;
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .status-pill {
                margin-top: 0;
                width: auto;
            }
            
            main {
                margin-left: 0;
                width: 100%;
                padding: 20px;
            }
            
            .header-flex {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .header-flex > div:last-child {
                text-align: left;
                width: 100%;
            }
            
            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .date-filter-container {
                width: 100%;
                justify-content: flex-start;
            }
        }

        @media (max-width: 480px) {
            .logo-text {
                font-size: 20px;
            }
            
            .btn-edit, .btn-delete {
                padding: 6px 12px;
                font-size: 11px;
                margin-right: 3px;
            }
            
            tr.item-row td {
                padding: 12px 8px;
            }
            
            .period-toggle {
                width: 100%;
                justify-content: center;
            }
            
            .period-btn {
                padding: 8px 15px;
                font-size: 12px;
            }

            .date-filter-btn {
                padding: 10px 14px;
                font-size: 13px;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>

    <sidebar>
        <div class="logo-container">
            <div class="logo-sq">A</div>
            <div class="logo-text">AuraPOS</div>
        </div>
        <p style="font-size: 12px; font-weight: 700; color: #ADB5BD; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px;">Main Menu</p>
        <div style="flex-grow: 1;">
            <div class="nav-item active" data-target="view-dashboard">Dashboard</div>
            <div class="nav-item" data-target="view-sales">Sales History</div>
            <div class="nav-item" data-target="view-settings">Settings</div>
        </div>
        <div class="status-pill">‚óè System Online</div>
    </sidebar>

    <main>
        <div class="header-flex">
            <div class="greeting">
                <h1 id="page-title">Store Operations</h1>
                <p id="page-subtitle" style="color: var(--muted-text);">Manage your inventory and sales in South Africa.</p>
            </div>
            <div style="text-align: right;">
                <p id="clock" style="font-weight: 800; font-size: 18px;"></p>
                <p style="color: var(--muted-text); font-size: 14px;">Pretoria, ZA</p>
            </div>
        </div>

        <div id="view-dashboard" class="view active">
            <!-- NEW MANAGER FEATURES START -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; flex-wrap: wrap; gap: 15px;">
                <div class="period-toggle">
                    <button class="period-btn active" data-period="today">Today</button>
                    <button class="period-btn" data-period="week">This Week</button>
                    <button class="period-btn" data-period="month">This Month</button>
                </div>
                <button class="btn-pill" id="endOfDayBtn" style="width:auto;padding:14px 32px;font-size:15px;">
                    üìã End of Day Report (PDF)
                </button>
            </div>

            <div class="kpi-grid" id="kpiGrid"></div>

            <div class="goal-card" style="margin-bottom:30px;">
                <h3 style="margin-bottom:8px;">Monthly Revenue Goal</h3>
                <div style="font-size:15px;color:var(--muted-text);">R25,000 target ‚Ä¢ <span id="goalPercent" style="color:#00B894;font-weight:800;">68%</span> achieved</div>
                <div class="goal-bar"><div class="goal-progress"></div></div>
                <div style="font-size:13px;color:#00B894;font-weight:700;">On track ‚Äì R17,000 so far this month</div>
            </div>

            <div class="card" style="margin-bottom:30px;">
                <div class="table-header">
                    <h3>Live Sales Ticker</h3>
                    <div class="date-filter-container">
                        <button class="date-filter-btn" id="tickerDateFilterBtn">
                            <span id="tickerDateDisplay">20/02/2026</span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                            </svg>
                        </button>
                        <input type="date" id="tickerDateInput" class="date-filter-input">
                    </div>
                </div>
                <div id="liveTicker" class="live-ticker"></div>
            </div>

            <div class="card low-stock-panel" style="margin-bottom:30px;">
                <h3>Low Stock & Alerts <span id="lowStockCount" class="stock-out" style="padding:4px 14px;font-size:13px;margin-left:8px;"></span></h3>
                <div id="lowStockList"></div>
            </div>

            <!-- ORIGINAL DASHBOARD CONTENT (unchanged) -->
            <div class="dashboard-grid">
                <div class="card">
                    <h3>Add New Product</h3>
                    <div class="input-group">
                        <label>Product Name</label>
                        <input type="text" id="itemName" placeholder="e.g. Leather Jacket">
                    </div>
                    <div class="input-group">
                        <label>Category</label>
                        <select id="itemCategory">
                            <option value="Uncategorized">Select Category...</option>
                            <option value="Drinks">Drinks</option>
                            <option value="Food">Food</option>
                            <option value="Clothing">Clothing</option>
                            <option value="Accessories">Accessories</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Price (Rand)</label>
                        <input type="number" id="itemPrice" placeholder="R 0.00">
                    </div>
                    <div class="input-group">
                        <label>Discount (%) - Optional</label>
                        <input type="number" id="itemDiscount" placeholder="0">
                    </div>
                    <div class="input-group">
                        <label>Opening Stock</label>
                        <input type="number" id="itemQty" placeholder="0">
                    </div>
                    <div class="input-group">
                        <label>Product Image (Cloudinary)</label>
                        <input type="file" id="itemImage" accept="image/*">
                    </div>
                    <button class="btn-pill" id="addBtn">
                        <span>Add to Inventory</span>
                    </button>
                </div>

                <div class="card">
                    <div class="table-header">
                        <h3>Live Inventory</h3>
                        <input type="text" id="searchInput" class="search-bar" placeholder="üîç Search items...">
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Product Details</th>
                                    <th>Stock Level</th>
                                    <th>Price</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 30px;">
                <h3>Basic Analytics</h3>
                <div class="analytics-grid">
                    <div>
                        <h4 style="font-size: 14px; margin-bottom: 10px; color: var(--muted-text);">Stock Value</h4>
                        <div class="chart-container"><canvas id="stockValueChart"></canvas></div>
                    </div>
                    <div>
                        <h4 style="font-size: 14px; margin-bottom: 10px; color: var(--muted-text);">Top-Selling Items</h4>
                        <div class="chart-container"><canvas id="topSellingChart"></canvas></div>
                    </div>
                    <div>
                        <h4 style="font-size: 14px; margin-bottom: 10px; color: var(--muted-text);">Sales Over Time</h4>
                        <div class="chart-container"><canvas id="salesTimeChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SALES HISTORY - REAL DATA -->
        <div id="view-sales" class="view">
            <div class="card">
                <div class="table-header">
                    <h3>Sales History Log</h3>
                    <div class="date-filter-container">
                        <button class="date-filter-btn" id="salesDateFilterBtn">
                            <span id="salesDateDisplay">20/02/2026</span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                            </svg>
                        </button>
                        <input type="date" id="salesDateInput" class="date-filter-input">
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Product</th>
                                <th>Revenue (R)</th>
                            </tr>
                        </thead>
                        <tbody id="salesBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SETTINGS - REAL CONFIGURATIONS -->
        <div id="view-settings" class="view">
            <div class="card">
                <h3>Store Configuration</h3>
                <div class="settings-grid">
                    <div class="input-group">
                        <label>Store Name</label>
                        <input type="text" id="storeName" placeholder="AuraPOS Pretoria">
                    </div>
                    <div class="input-group">
                        <label>VAT Number</label>
                        <input type="text" id="vatNumber" placeholder="1234567890123">
                    </div>
                    <div class="input-group">
                        <label>Store Address</label>
                        <input type="text" id="storeAddress" placeholder="123 Church Street, Pretoria">
                    </div>
                    <div class="input-group">
                        <label>Monthly Revenue Goal (R)</label>
                        <input type="number" id="monthlyGoal" value="25000">
                    </div>
                    <div class="input-group">
                        <label>Low Stock Alert Threshold</label>
                        <input type="number" id="lowStockThreshold" value="5">
                    </div>
                </div>
                <button class="btn-pill" id="saveSettingsBtn" style="margin-top:20px;">Save Configuration</button>
            </div>
        </div>
    </main>

    <!-- EDIT MODAL -->
    <div id="editModal">
        <div class="modal-content">
            <h3>Edit Product</h3>
            <img id="editImagePreview" class="image-preview" src="" alt="Product Image" style="display:none;">
            <div class="input-group">
                <label>Change Image</label>
                <input type="file" id="editImage" accept="image/*">
            </div>
            <div class="input-group">
                <label>Name</label>
                <input type="text" id="editName">
            </div>
            <div class="input-group">
                <label>Price</label>
                <input type="number" id="editPrice">
            </div>
            <div class="input-group">
                <label>Discount %</label>
                <input type="number" id="editDiscount">
            </div>
            <div class="input-group">
                <label>Stock</label>
                <input type="number" id="editQty">
            </div>
            <div style="display:flex; gap:12px; flex-wrap: wrap;">
                <button class="btn-pill" id="saveEditBtn" style="flex:1; min-width: 120px;">Save Changes</button>
                <button class="btn-pill" id="cancelEditBtn" style="flex:1; min-width: 120px; background:#e9ecef;color:#333;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- DELETE CONFIRMATION MODAL -->
    <div id="deleteModal">
        <div class="delete-modal-content">
            <h3>‚ö†Ô∏è Delete Product</h3>
            <p>Are you sure you want to delete <strong id="deleteItemName"></strong>? This action cannot be undone.</p>
            <div class="delete-modal-buttons">
                <button class="btn-cancel" id="cancelDeleteBtn">Cancel</button>
                <button class="btn-confirm-delete" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <div id="toast">Stock Alert Notification</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js ";
        import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js ";

        // 0. Tab Switching Logic (unchanged)
        const navItems = document.querySelectorAll('.nav-item');
        const views = document.querySelectorAll('.view');
        const pageTitle = document.getElementById('page-title');
        const pageSubtitle = document.getElementById('page-subtitle');

        const pageHeaders = {
            'view-dashboard': { title: 'Store Operations', subtitle: 'Manage your inventory and sales in South Africa.' },
            'view-sales': { title: 'Sales History', subtitle: 'Review your past transactions and revenue logs.' },
            'view-settings': { title: 'Settings', subtitle: 'Manage your store configurations and preferences.' }
        };

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
                
                const targetId = item.getAttribute('data-target');
                views.forEach(view => view.classList.remove('active'));
                document.getElementById(targetId).classList.add('active');

                pageTitle.innerText = pageHeaders[targetId].title;
                pageSubtitle.innerText = pageHeaders[targetId].subtitle;
            });
        });

        // Firebase Config (unchanged)
        const firebaseConfig = {
            apiKey: "AIzaSyAxBT0oESoL62oz_x_Z8cMtdENWZPx4tMI",
            authDomain: "pinotp-d7ef5.firebaseapp.com",
            databaseURL: "https://pinotp-d7ef5-default-rtdb.firebaseio.com ",
            projectId: "pinotp-d7ef5",
            storageBucket: "pinotp-d7ef5.firebasestorage.app",
            messagingSenderId: "708458917827",
            appId: "1:708458917827:web:375de278577df0adcf9776"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const inventoryRef = ref(db, 'inventory');
        const salesRef = ref(db, 'sales');
        const settingsRef = ref(db, 'settings');

        // Chart Instances (unchanged)
        let stockChart, topChart, timeChart;

        // Clock (unchanged)
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('en-ZA');
        }, 1000);

        // ==================== CLOUDINARY CONFIG - REPLACE WITH YOURS ====================
        const CLOUD_NAME = "dv5bsbydu";     // ‚Üê CHANGE THIS
        const UPLOAD_PRESET = "admin_tlaka";       // ‚Üê CHANGE THIS (create unsigned preset in Cloudinary dashboard)

        async function uploadToCloudinary(file) {
            if (!file) return null;
            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", UPLOAD_PRESET);
            const response = await fetch(`https://api.cloudinary.com/v1_1/ ${CLOUD_NAME}/image/upload`, {
                method: "POST",
                body: formData
            });
            const data = await response.json();
            return data.secure_url;
        }
        // ================================================================================

        // Add Item (enhanced with image)
        document.getElementById('addBtn').addEventListener('click', async () => {
            const name = document.getElementById('itemName').value.trim();
            const category = document.getElementById('itemCategory').value;
            const price = document.getElementById('itemPrice').value;
            const discount = document.getElementById('itemDiscount').value || 0;
            const qty = document.getElementById('itemQty').value;
            const file = document.getElementById('itemImage').files[0];

            if (!name || !price || !qty) return;

            let imageURL = null;
            if (file) {
                imageURL = await uploadToCloudinary(file);
            }

            push(inventoryRef, {
                name: name,
                category: category !== 'Uncategorized' ? category : 'General',
                price: parseFloat(price).toFixed(2),
                discount: parseFloat(discount),
                qty: parseInt(qty),
                imageURL: imageURL
            }).then(() => {
                // Clear form
                document.getElementById('itemName').value = '';
                document.getElementById('itemCategory').value = 'Uncategorized';
                document.getElementById('itemPrice').value = '';
                document.getElementById('itemDiscount').value = '';
                document.getElementById('itemQty').value = '';
                document.getElementById('itemImage').value = '';
                showToast(`Added ${name} to inventory!`);
            });
        });

        // Inventory Sync (enhanced with image + edit/delete buttons, removed sell button)
        onValue(inventoryRef, (snapshot) => {
            const data = snapshot.val();
            const tableBody = document.getElementById('inventoryBody');
            tableBody.innerHTML = '';

            const stockLabels = [];
            const stockValues = [];
            const topSellingLabels = [];
            const topSellingData = [];

            if (data) {
                const groupedItems = {};
                Object.keys(data).forEach(key => {
                    const item = data[key];
                    const cat = item.category || 'General';
                    if (!groupedItems[cat]) groupedItems[cat] = [];
                    groupedItems[cat].push({ key, ...item });

                    stockLabels.push(item.name);
                    const finalPrice = item.price - (item.price * (item.discount || 0) / 100);
                    stockValues.push(item.qty * finalPrice);
                    
                    // For top selling chart
                    topSellingLabels.push(item.name);
                    topSellingData.push(item.qty > 0 ? 100 - item.qty : 0); // Higher sales = lower stock
                });

                Object.keys(groupedItems).forEach(cat => {
                    const catRow = document.createElement('tr');
                    catRow.className = 'category-row';
                    catRow.innerHTML = `<td colspan="4">${cat}</td>`;
                    tableBody.appendChild(catRow);

                    groupedItems[cat].forEach(item => {
                        const row = document.createElement('tr');
                        row.className = 'item-row';
                        row.setAttribute('data-name', item.name.toLowerCase());

                        const hasDiscount = item.discount > 0;
                        const finalPrice = hasDiscount 
                            ? (item.price - (item.price * item.discount / 100)).toFixed(2) 
                            : parseFloat(item.price).toFixed(2);
                        
                        const priceDisplay = hasDiscount 
                            ? `<span class="discount-text">R ${item.price} (-${item.discount}%)</span><span>R ${finalPrice}</span>`
                            : `<span>R ${finalPrice}</span>`;

                        let badgeClass = 'stock-safe';
                        if (item.qty <= 0) badgeClass = 'stock-out';
                        else if (item.qty <= 5) badgeClass = 'stock-low';

                        const imgHTML = item.imageURL 
                            ? `<img src="${item.imageURL}" style="width:40px;height:40px;object-fit:cover;border-radius:8px;margin-right:12px;vertical-align:middle;">` 
                            : '';

                        row.innerHTML = `
                            <td>${imgHTML}<strong style="font-size:15px">${item.name}</strong></td>
                            <td><span class="stock-badge ${badgeClass}">${item.qty} units</span></td>
                            <td class="price-tag">${priceDisplay}</td>
                            <td>
                                <button class="btn-edit" data-id="${item.key}">Edit</button>
                                <button class="btn-delete" data-id="${item.key}" data-name="${item.name}">Delete</button>
                            </td>
                        `;

                        row.querySelector('.btn-edit').onclick = () => openEditModal(item.key, item);
                        row.querySelector('.btn-delete').onclick = () => openDeleteModal(item.key, item.name);

                        tableBody.appendChild(row);
                    });
                });
            } else {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999; padding:40px;">No inventory found. Add your first product.</td></tr>';
            }

            updateStockChart(stockLabels, stockValues);
            updateTopChart(topSellingLabels, topSellingData);
            filterTable();
        });

        // Date Filter Logic
        let tickerFilterDate = new Date();
        let salesFilterDate = new Date();
        let allSalesData = [];

        function formatDateToDisplay(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function formatDateToInput(date) {
            return date.toISOString().split('T')[0];
        }

        function isSameDay(date1, date2) {
            return date1.getDate() === date2.getDate() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getFullYear() === date2.getFullYear();
        }

        // Ticker Date Filter
        const tickerDateInput = document.getElementById('tickerDateInput');
        const tickerDateDisplay = document.getElementById('tickerDateDisplay');
        const tickerDateFilterBtn = document.getElementById('tickerDateFilterBtn');

        tickerDateDisplay.textContent = formatDateToDisplay(tickerFilterDate);
        tickerDateInput.value = formatDateToInput(tickerFilterDate);

        tickerDateFilterBtn.addEventListener('click', () => {
            tickerDateInput.showPicker();
        });

        tickerDateInput.addEventListener('change', (e) => {
            if (e.target.value) {
                tickerFilterDate = new Date(e.target.value);
                tickerDateDisplay.textContent = formatDateToDisplay(tickerFilterDate);
                updateLiveTicker();
            }
        });

        // Sales History Date Filter
        const salesDateInput = document.getElementById('salesDateInput');
        const salesDateDisplay = document.getElementById('salesDateDisplay');
        const salesDateFilterBtn = document.getElementById('salesDateFilterBtn');

        salesDateDisplay.textContent = formatDateToDisplay(salesFilterDate);
        salesDateInput.value = formatDateToInput(salesFilterDate);

        salesDateFilterBtn.addEventListener('click', () => {
            salesDateInput.showPicker();
        });

        salesDateInput.addEventListener('change', (e) => {
            if (e.target.value) {
                salesFilterDate = new Date(e.target.value);
                salesDateDisplay.textContent = formatDateToDisplay(salesFilterDate);
                updateSalesHistory();
            }
        });

        // Sales History - REAL DATA with Date Filter
        function updateSalesHistory() {
            const salesBody = document.getElementById('salesBody');
            salesBody.innerHTML = '';

            const filteredSales = allSalesData.filter(sale => {
                const saleDate = new Date(sale.timestamp);
                return isSameDay(saleDate, salesFilterDate);
            });

            if (filteredSales.length > 0) {
                filteredSales.forEach(sale => {
                    const date = new Date(sale.timestamp);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${date.toLocaleDateString('en-ZA')}</td>
                        <td>${date.toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' })}</td>
                        <td><strong>${sale.name}</strong></td>
                        <td style="font-weight:700;">${parseFloat(sale.revenue).toFixed(2)}</td>
                    `;
                    salesBody.appendChild(row);
                });
            } else {
                salesBody.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:40px;color:#999;">No sales recorded for ${formatDateToDisplay(salesFilterDate)}.</td></tr>`;
            }
        }

        onValue(salesRef, (snapshot) => {
            const data = snapshot.val();
            allSalesData = data ? Object.entries(data).map(([id, sale]) => ({ id, ...sale }))
                .sort((a, b) => b.timestamp - a.timestamp) : [];
            
            updateSalesHistory();
            
            // Also update manager features
            allSales = allSalesData;
            updateLiveTicker();
            updateKPICards();
            updateTimeChartFromSales(allSales); // Update sales over time chart
        });

        // Edit Modal with Image Support
        let currentEditKey = null;
        let currentImageURL = null;
        
        function openEditModal(key, item) {
            currentEditKey = key;
            currentImageURL = item.imageURL;
            
            document.getElementById('editName').value = item.name;
            document.getElementById('editPrice').value = item.price;
            document.getElementById('editDiscount').value = item.discount || 0;
            document.getElementById('editQty').value = item.qty;
            
            // Show current image if exists
            const imgPreview = document.getElementById('editImagePreview');
            if (item.imageURL) {
                imgPreview.src = item.imageURL;
                imgPreview.style.display = 'block';
            } else {
                imgPreview.style.display = 'none';
            }
            
            document.getElementById('editModal').style.display = 'flex';
        }

        document.getElementById('saveEditBtn').addEventListener('click', async () => {
            if (!currentEditKey) return;
            
            const file = document.getElementById('editImage').files[0];
            let newImageURL = currentImageURL;
            
            if (file) {
                newImageURL = await uploadToCloudinary(file);
            }
            
            const updates = {
                name: document.getElementById('editName').value,
                price: parseFloat(document.getElementById('editPrice').value).toFixed(2),
                discount: parseFloat(document.getElementById('editDiscount').value),
                qty: parseInt(document.getElementById('editQty').value),
                imageURL: newImageURL
            };
            
            update(ref(db, `inventory/${currentEditKey}`), updates).then(() => {
                document.getElementById('editModal').style.display = 'none';
                document.getElementById('editImage').value = '';
                showToast('Product updated successfully');
            });
        });

        document.getElementById('cancelEditBtn').addEventListener('click', () => {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editImage').value = '';
        });

        // Delete Confirmation Modal
        let itemToDeleteKey = null;
        let itemToDeleteName = null;

        function openDeleteModal(key, name) {
            itemToDeleteKey = key;
            itemToDeleteName = name;
            document.getElementById('deleteItemName').textContent = name;
            document.getElementById('deleteModal').style.display = 'flex';
        }

        document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
            document.getElementById('deleteModal').style.display = 'none';
            itemToDeleteKey = null;
            itemToDeleteName = null;
        });

        document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
            if (itemToDeleteKey) {
                remove(ref(db, `inventory/${itemToDeleteKey}`)).then(() => {
                    showToast(`${itemToDeleteName} deleted`);
                    document.getElementById('deleteModal').style.display = 'none';
                    itemToDeleteKey = null;
                    itemToDeleteName = null;
                });
            }
        });

        // Search (unchanged)
        document.getElementById('searchInput').addEventListener('input', filterTable);
        function filterTable() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('.item-row');
            rows.forEach(row => {
                const name = row.getAttribute('data-name');
                row.style.display = name.includes(query) ? '' : 'none';
            });
        }

        // Toast (unchanged)
        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.innerHTML = message;
            toast.className = "show";
            setTimeout(() => { toast.className = ""; }, 3000);
        }

        // Charts (updated with top selling chart and sales over time)
        Chart.defaults.font.family = "'Plus Jakarta Sans', sans-serif";
        const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };

        function updateStockChart(labels, data) {
            const ctx = document.getElementById('stockValueChart').getContext('2d');
            if (stockChart) stockChart.destroy();
            stockChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ data: data, backgroundColor: '#FFD700', borderRadius: 6 }] },
                options: chartOptions
            });
        }

        function updateTopChart(labels, data) {
            const ctx = document.getElementById('topSellingChart').getContext('2d');
            if (topChart) topChart.destroy();
            topChart = new Chart(ctx, {
                type: 'pie',
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        data: data, 
                        backgroundColor: ['#FFD700', '#00B894', '#0984E3', '#6C5CE7', '#FF7675', '#FDCB6E', '#E17055', '#74B9FF'], 
                        borderWidth: 2,
                        borderColor: '#fff'
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { 
                            display: true, 
                            position: 'right', 
                            labels: { 
                                boxWidth: 12,
                                font: { size: 10 }
                            } 
                        } 
                    } 
                }
            });
        }

        // NEW: Sales Over Time Chart Function
        function updateTimeChartFromSales(salesData) {
            const ctx = document.getElementById('salesTimeChart').getContext('2d');
            
            // Group sales by date
            const salesByDate = {};
            
            if (salesData && salesData.length > 0) {
                salesData.forEach(sale => {
                    const date = new Date(sale.timestamp);
                    const dateKey = date.toLocaleDateString('en-ZA', { day: '2-digit', month: 'short' });
                    
                    if (!salesByDate[dateKey]) {
                        salesByDate[dateKey] = 0;
                    }
                    salesByDate[dateKey] += parseFloat(sale.revenue || 0);
                });
            }
            
            // Sort dates chronologically
            const sortedDates = Object.keys(salesByDate).sort((a, b) => {
                const dateA = new Date(a + ' 2024');
                const dateB = new Date(b + ' 2024');
                return dateA - dateB;
            });
            
            const labels = sortedDates.length > 0 ? sortedDates : ['No Data'];
            const data = sortedDates.length > 0 ? sortedDates.map(date => salesByDate[date]) : [0];
            
            if (timeChart) timeChart.destroy();
            
            timeChart = new Chart(ctx, {
                type: 'line',
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        label: 'Revenue (R)',
                        data: data, 
                        borderColor: '#1A1C1E', 
                        backgroundColor: 'rgba(255, 215, 0, 0.1)', 
                        fill: true, 
                        tension: 0.4,
                        pointBackgroundColor: '#FFD700',
                        pointBorderColor: '#1A1C1E',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }] 
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'R ' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R ' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Manager KPI / Ticker / Low Stock (unchanged from previous version)
        let allSales = [];
        let currentPeriod = 'today';

        function calculatePeriodStats(period) {
            const now = Date.now();
            let startTime = 0;
            if (period === 'today') {
                const today = new Date(); today.setHours(0,0,0,0); startTime = today.getTime();
            } else if (period === 'week') {
                startTime = now - 7 * 24 * 60 * 60 * 1000;
            } else {
                const monthStart = new Date(); monthStart.setDate(1); monthStart.setHours(0,0,0,0); startTime = monthStart.getTime();
            }
            const filtered = allSales.filter(s => s.timestamp >= startTime);
            const revenue = filtered.reduce((sum, s) => sum + parseFloat(s.revenue || 0), 0);
            const count = filtered.length;
            const avg = count > 0 ? (revenue / count).toFixed(0) : 0;
            return { revenue: revenue.toFixed(0), count, avg };
        }

        function updateKPICards() {
            const stats = calculatePeriodStats(currentPeriod);
            const yesterdayStats = { revenue: 10500 };
            const percentChange = stats.revenue > 0 ? Math.round(((stats.revenue - yesterdayStats.revenue) / yesterdayStats.revenue) * 100) : 0;

            document.getElementById('kpiGrid').innerHTML = `
                <div class="kpi-card">
                    <div class="kpi-label">Revenue</div>
                    <div class="kpi-value">R ${stats.revenue}</div>
                    <div class="kpi-change ${percentChange >= 0 ? 'change-positive' : 'change-negative'}">
                        ${percentChange >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(percentChange)}% vs previous
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Transactions</div>
                    <div class="kpi-value">${stats.count}</div>
                    <div class="kpi-change">Avg R${stats.avg}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Avg Basket Size</div>
                    <div class="kpi-value">2.4</div>
                    <div class="kpi-change change-positive">‚Üë 0.3 vs last period</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Gross Profit</div>
                    <div class="kpi-value">42%</div>
                    <div class="kpi-change change-positive">after cost price</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Low Stock Items</div>
                    <div class="kpi-value" id="kpiLowStock">12</div>
                    <div class="kpi-change">need attention</div>
                </div>
            `;
        }

        function updateLiveTicker() {
            const container = document.getElementById('liveTicker');
            container.innerHTML = '';
            
            const filteredSales = allSales.filter(sale => {
                const saleDate = new Date(sale.timestamp);
                return isSameDay(saleDate, tickerFilterDate);
            });
            
            const latest = filteredSales.slice(0, 10);
            latest.forEach(sale => {
                const timeAgo = Math.floor((Date.now() - sale.timestamp) / 60000);
                const item = document.createElement('div');
                item.className = 'ticker-item';
                item.innerHTML = `
                    <div><strong>${sale.name}</strong></div>
                    <div style="text-align:right;">
                        <div style="font-weight:700;">R ${parseFloat(sale.revenue).toFixed(0)}</div>
                        <div style="font-size:11px;color:var(--muted-text);">Cash ‚Ä¢ ${timeAgo} min ago</div>
                    </div>
                `;
                container.appendChild(item);
            });
            
            if (latest.length === 0) {
                container.innerHTML = `<div style="text-align:center;padding:20px;color:#999;">No sales for ${formatDateToDisplay(tickerFilterDate)}</div>`;
            }
        }

        function updateLowStockPanel(snapshot) {
            const data = snapshot.val();
            if (!data) return;
            const lowItems = Object.values(data).filter(i => i.qty <= 5);
            document.getElementById('lowStockCount').textContent = `${lowItems.length} items`;
            const container = document.getElementById('lowStockList');
            container.innerHTML = '';
            lowItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'alert-item';
                div.innerHTML = `<strong>${item.name}</strong><br><span style="color:#D63031;">Only ${item.qty} units left</span>`;
                container.appendChild(div);
            });
            const kpiEl = document.getElementById('kpiLowStock');
            if (kpiEl) kpiEl.textContent = lowItems.length;
        }

        // Period toggle
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentPeriod = btn.dataset.period;
                updateKPICards();
            });
        });

        // End of Day PDF with Tables and Charts
        document.getElementById('endOfDayBtn').addEventListener('click', async () => {
            const todaySales = allSales.filter(s => {
                const d = new Date(s.timestamp);
                const today = new Date();
                return d.getDate() === today.getDate() && d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear();
            });
            
            const total = todaySales.reduce((sum, s) => sum + parseFloat(s.revenue || 0), 0);
            const today = new Date();

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFont("helvetica", "bold");
            doc.setFontSize(20);
            doc.setTextColor(255, 215, 0); // Gold color
            doc.text("AURA POS", 20, 20);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text("END OF DAY REPORT", 20, 28);
            
            // Date and Summary Box
            doc.setFillColor(247, 249, 252);
            doc.roundedRect(20, 35, 170, 30, 3, 3, 'F');
            
            doc.setFont("helvetica", "bold");
            doc.setFontSize(11);
            doc.text(`Date: ${today.toLocaleDateString('en-ZA')}`, 25, 45);
            doc.text(`Total Revenue: R ${total.toFixed(2)}`, 25, 55);
            doc.text(`Transactions: ${todaySales.length}`, 100, 45);
            doc.text(`Avg Transaction: R ${todaySales.length > 0 ? (total / todaySales.length).toFixed(2) : '0.00'}`, 100, 55);

            // Sales Table
            doc.setFont("helvetica", "bold");
            doc.setFontSize(14);
            doc.text("Sales Details", 20, 80);

            const tableData = todaySales.map(sale => {
                const date = new Date(sale.timestamp);
                return [
                    date.toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' }),
                    sale.name,
                    `R ${parseFloat(sale.revenue).toFixed(2)}`
                ];
            });

            doc.autoTable({
                startY: 85,
                head: [['Time', 'Product', 'Revenue']],
                body: tableData.length > 0 ? tableData : [['No sales', '', 'R 0.00']],
                theme: 'striped',
                headStyles: {
                    fillColor: [255, 215, 0],
                    textColor: 0,
                    fontStyle: 'bold'
                },
                styles: {
                    fontSize: 10,
                    cellPadding: 5
                },
                columnStyles: {
                    0: { cellWidth: 30 },
                    1: { cellWidth: 'auto' },
                    2: { cellWidth: 40, halign: 'right' }
                }
            });

            // Check if we need a new page for charts
            let chartY = doc.lastAutoTable.finalY + 20;
            if (chartY > 200) {
                doc.addPage();
                chartY = 30;
            }

            // Sales by Hour Chart
            doc.setFont("helvetica", "bold");
            doc.setFontSize(14);
            doc.text("Sales by Hour", 20, chartY);

            // Group sales by hour
            const salesByHour = {};
            for (let i = 0; i < 24; i++) {
                salesByHour[i] = 0;
            }
            
            todaySales.forEach(sale => {
                const hour = new Date(sale.timestamp).getHours();
                salesByHour[hour] += parseFloat(sale.revenue || 0);
            });

            // Draw bar chart
            const chartStartY = chartY + 10;
            const chartHeight = 50;
            const chartWidth = 170;
            const barWidth = chartWidth / 24;
            const maxValue = Math.max(...Object.values(salesByHour)) || 1;

            // Chart background
            doc.setDrawColor(200, 200, 200);
            doc.setFillColor(255, 255, 255);
            doc.rect(20, chartStartY, chartWidth, chartHeight, 'FD');

            // Draw bars
            Object.keys(salesByHour).forEach((hour, index) => {
                const value = salesByHour[hour];
                const barHeight = (value / maxValue) * (chartHeight - 10);
                
                if (value > 0) {
                    // Gradient effect using multiple rectangles
                    const gradientSteps = 5;
                    for (let i = 0; i < gradientSteps; i++) {
                        const ratio = i / gradientSteps;
                        const r = Math.floor(255 - (255 - 255) * ratio);
                        const g = Math.floor(255 - (255 - 215) * ratio);
                        const b = Math.floor(255 - (255 - 0) * ratio);
                        doc.setFillColor(r, g, b);
                        
                        const stepHeight = barHeight / gradientSteps;
                        doc.rect(
                            20 + (index * barWidth) + 1, 
                            chartStartY + chartHeight - 5 - ((i + 1) * stepHeight), 
                            barWidth - 2, 
                            stepHeight, 
                            'F'
                        );
                    }
                }
            });

            // Chart axes
            doc.setDrawColor(100, 100, 100);
            doc.setLineWidth(0.5);
            doc.line(20, chartStartY + chartHeight - 5, 20 + chartWidth, chartStartY + chartHeight - 5);
            doc.line(20, chartStartY, 20, chartStartY + chartHeight - 5);

            // X-axis labels (every 4 hours)
            doc.setFont("helvetica", "normal");
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            for (let i = 0; i < 24; i += 4) {
                doc.text(`${i}:00`, 20 + (i * barWidth) + 2, chartStartY + chartHeight + 5);
            }

            // Y-axis label
            doc.setFontSize(9);
            doc.text(`Max: R ${maxValue.toFixed(0)}`, 5, chartStartY + 5);

            // Check for new page for pie chart
            let pieY = chartStartY + chartHeight + 30;
            if (pieY > 250) {
                doc.addPage();
                pieY = 40;
            }

            // Top Products Pie Chart
            doc.setFont("helvetica", "bold");
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text("Top Selling Products", 20, pieY);

            // Group sales by product
            const salesByProduct = {};
            todaySales.forEach(sale => {
                if (!salesByProduct[sale.name]) {
                    salesByProduct[sale.name] = { count: 0, revenue: 0 };
                }
                salesByProduct[sale.name].count++;
                salesByProduct[sale.name].revenue += parseFloat(sale.revenue || 0);
            });

            const sortedProducts = Object.entries(salesByProduct)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 5);

            // Draw simple pie chart
            const pieCenterX = 60;
            const pieCenterY = pieY + 40;
            const pieRadius = 30;
            const colors = [
                [255, 215, 0],   // Gold
                [0, 184, 148],   // Green
                [9, 132, 227],   // Blue
                [108, 92, 231],  // Purple
                [255, 118, 117]  // Red
            ];

            if (sortedProducts.length > 0) {
                const totalProductRevenue = sortedProducts.reduce((sum, [, data]) => sum + data.revenue, 0);
                let currentAngle = 0;

                sortedProducts.forEach(([name, data], index) => {
                    const sliceAngle = (data.revenue / totalProductRevenue) * 2 * Math.PI;
                    
                    // Draw slice
                    doc.setFillColor(...colors[index % colors.length]);
                    doc.setDrawColor(255, 255, 255);
                    doc.setLineWidth(1);
                    
                    // Create pie slice using multiple line segments
                    const steps = 20;
                    const angleStep = sliceAngle / steps;
                    let points = [{x: pieCenterX, y: pieCenterY}];
                    
                    for (let i = 0; i <= steps; i++) {
                        const angle = currentAngle + (i * angleStep);
                        points.push({
                            x: pieCenterX + pieRadius * Math.cos(angle),
                            y: pieCenterY + pieRadius * Math.sin(angle)
                        });
                    }
                    
                    // Draw the slice
                    doc.lines(
                        points.map((p, i) => i === 0 ? [0, 0] : [p.x - points[i-1].x, p.y - points[i-1].y]),
                        pieCenterX,
                        pieCenterY,
                        [1, 1],
                        'FD'
                    );

                    currentAngle += sliceAngle;
                });

                // Legend
                let legendY = pieY + 15;
                sortedProducts.forEach(([name, data], index) => {
                    doc.setFillColor(...colors[index % colors.length]);
                    doc.rect(110, legendY, 8, 8, 'F');
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(9);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`${name} (${data.count}) - R ${data.revenue.toFixed(0)}`, 122, legendY + 6);
                    legendY += 12;
                });
            } else {
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.text("No sales data available", pieCenterX - 20, pieCenterY);
            }

            // Footer
            const pageCount = doc.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFont("helvetica", "normal");
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`Page ${i} of ${pageCount} - Generated by AuraPOS`, 20, 290);
                doc.text(`Pretoria, South Africa`, 160, 290);
            }

            doc.save(`AuraPOS_EndOfDay_${today.toISOString().slice(0,10)}.pdf`);
            showToast('‚úÖ End of Day PDF Downloaded with Tables & Charts');
        });

        // Settings
        onValue(settingsRef, (snapshot) => {
            const s = snapshot.val() || {};
            document.getElementById('storeName').value = s.storeName || 'AuraPOS Pretoria';
            document.getElementById('vatNumber').value = s.vatNumber || '';
            document.getElementById('storeAddress').value = s.storeAddress || '';
            document.getElementById('monthlyGoal').value = s.monthlyGoal || 25000;
            document.getElementById('lowStockThreshold').value = s.lowStockThreshold || 5;
        });

        document.getElementById('saveSettingsBtn').addEventListener('click', () => {
            const settingsData = {
                storeName: document.getElementById('storeName').value,
                vatNumber: document.getElementById('vatNumber').value,
                storeAddress: document.getElementById('storeAddress').value,
                monthlyGoal: parseFloat(document.getElementById('monthlyGoal').value),
                lowStockThreshold: parseInt(document.getElementById('lowStockThreshold').value)
            };
            update(settingsRef, settingsData).then(() => {
                showToast('‚úÖ Settings saved');
            });
        });

        // Manager realtime listeners
        onValue(salesRef, (snapshot) => {
            const data = snapshot.val();
            allSales = data ? Object.values(data).sort((a,b) => b.timestamp - a.timestamp) : [];
            updateLiveTicker();
            updateKPICards();
            updateTimeChartFromSales(allSales); // Update sales over time chart
        });

        onValue(inventoryRef, (snapshot) => {
            updateLowStockPanel(snapshot);
        });

        // Initialize
        window.addEventListener('load', () => {
            updateKPICards();
            // Initialize empty sales chart
            updateTimeChartFromSales([]);
        });
    </script>
</body>
</html>
